xong, chung ta truy cap vao, http://localhost:8080/index.php,
 da hien thi duoc noi dung trang php.

=============Tuy nhien chung ta co hai cau hoi ===========
- toi co hai thac mac,
1. tai sao phai cai them container php, trong khi co container
 nginx roi, chung ta vao container nay, cai dat php, cai dat php-fpm la xong ma nhi?
2. neu da cai php container, vay khi truy cap vao http://localhost:8080/index.php,
 ro rang dang trá» Ä‘áº¿n server cua nginx (theo nhu day 6, se khong hien thi duoc mÃ£ php),
 tai sao giá» lai Ä‘Æ°á»£c nhá»‰, thÃ¢t magic

- cau tra loi
1. Sao khÃ´ng cÃ i PHP ngay trong container Nginx?

Vá» ká»¹ thuáº­t: báº¡n hoÃ n toÃ n cÃ³ thá»ƒ dÃ¹ng 1 container chá»©a cáº£ Nginx láº«n PHP-FPM.

VÃ­ dá»¥ image bitnami/nginx-php-fpm hoáº·c tá»± build tá»« nginx:alpine rá»“i apk add php php-fpmâ€¦

Sau Ä‘Ã³ cáº¥u hÃ¬nh Nginx trá» Ä‘áº¿n 127.0.0.1:9000 (ná»™i bá»™ container).

NhÆ°ng Docker khuyáº¿n nghá»‹: 1 container = 1 process chÃ­nh (principle of single responsibility).

Container Nginx chá»‰ lo lÃ m reverse proxy / serve static.

Container PHP-FPM chá»‰ lo cháº¡y PHP code.

Dá»… scale: báº¡n cÃ³ thá»ƒ tÄƒng sá»‘ container PHP-FPM mÃ  khÃ´ng Ä‘á»™ng Ä‘áº¿n Nginx.
Dá»… update: update PHP lÃªn 8.3 chá»‰ rebuild container PHP, khÃ´ng rebuild container Nginx.
NÃªn trong thá»±c táº¿, DevOps hay lÃ m 2 container riÃªng nhÆ° váº­y.

2.Magic: sao http://localhost:8080/index.php láº¡i cháº¡y PHP?
  ÄÃºng lÃ  báº¡n truy cáº­p vÃ o Nginx container (port 8080 mapped tá»›i 80 trong container Nginx).
  Tuy nhiÃªn Nginx khÃ´ng â€œtá»± cháº¡y PHPâ€ mÃ  nÃ³ proxy request Ä‘Ã³ sang PHP-FPM container qua FastCGI:
  nginx/default.conf cÃ³ block:

  location ~ \.php$ {
      include fastcgi_params;
      fastcgi_pass php:9000;   # 'php' lÃ  tÃªn service trong docker-compose
      fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
  }


Khi báº¡n vÃ o /index.php, Nginx nháº­n request, nháº­n ra file .php,
khÃ´ng tá»± Ä‘á»c file mÃ  gá»­i ná»™i dung + path cá»§a file qua socket php:9000.
Container PHP-FPM nháº­n Ä‘Æ°á»£c, thá»±c thi PHP, tráº£ vá» HTML cho Nginx.
Nginx nháº­n HTML vÃ  gá»­i láº¡i cho browser.

Tá»©c lÃ :
Browser â‡„ Nginx (nghe port 8080) â‡„ PHP-FPM (port 9000 ná»™i bá»™ Docker)
Báº¡n khÃ´ng tháº¥y â€œmÃ£ PHPâ€ vÃ¬ browser khÃ´ng truy cáº­p trá»±c tiáº¿p PHP-FPM, mÃ  Nginx Ä‘Ã£ cháº¡y PHP rá»“i tráº£ vá» HTML.


=> tÃ³m gá»n
| CÃ¡ch                              | Æ¯u Ä‘iá»ƒm                                  | NhÆ°á»£c Ä‘iá»ƒm                 |
| --------------------------------- | ---------------------------------------- | -------------------------- |
| **CÃ i PHP trong container Nginx** | ÄÆ¡n giáº£n, 1 container                    | KhÃ³ scale, update PHP      |
| **2 container: Nginx + PHP-FPM**  | TÃ¡ch biá»‡t rÃµ, dá»… scale, chuáº©n production | Cáº¥u hÃ¬nh phá»©c táº¡p hÆ¡n chÃºt |



=============== bai hoc rut ra ================
nhu vay toi hieu tai sao nguoi ra build container redis,
 sql,php-fpm,... roi, de dá»… scale, sau nay tang so luong container len
  cho dá»…, vÃ  container nginx chá»‰ viá»‡c phÃ¢n phá»‘i request tá»›i cac container nÃ y.
  Logic tuong tá»± cho cÃ¡c service cá»§a chÃºng ta (vi du user-service, warehouse-serivce),
  co the co 3 container warehouse-serivce, 4 container user-service, scale
   vÃ£n dá»… dÃ ng (sau do dung nginx container lam reverse proxy, phan phoi request toi cac container tuong ung)

=>
MÃ´ hÃ¬nh hiá»‡n táº¡i báº¡n Ä‘ang thá»±c hÃ nh

Nginx container: chá»‰ Ä‘Ã³ng vai trÃ² gateway / load balancer / reverse proxy (nháº­n request tá»« ngoÃ i, route tá»›i cÃ¡c backend).

PHP-FPM container: thá»±c thi PHP (hoáº·c má»™t service backend khÃ¡c).

Redis container: cache/session store.

MySQL/Postgres container: database.

=> Má»—i thÃ nh pháº§n cÃ³ container riÃªng, scale theo nhu cáº§u.

ğŸ“ˆ Khi scale

VÃ­ dá»¥ service warehouse-service cháº¡y báº±ng NodeJS/NestJS:

Báº¡n cÃ³ thá»ƒ cháº¡y 3 container warehouse-service:

warehouse-service-1

warehouse-service-2

warehouse-service-3

Rá»“i Ä‘á»ƒ Nginx (hoáº·c traefik / API Gateway) phÃ¢n phá»‘i request Ä‘áº¿n cÃ¡c container nÃ y (round-robin, least-connectionsâ€¦).

TÆ°Æ¡ng tá»± user-service 4 container, inventory-service 2 containerâ€¦

Khi cáº§n nÃ¢ng cáº¥p phiÃªn báº£n má»›i:

Deploy thÃªm container má»›i vá»›i version má»›i â†’ test â†’ chuyá»ƒn traffic â†’ táº¯t container cÅ© (zero downtime).

ğŸ“ So sÃ¡nh vá»›i PHP-FPM

PHP-FPM lÃ  vÃ­ dá»¥ cá»¥ thá»ƒ: tÃ¡ch pháº§n webserver (Nginx) vÃ  pháº§n cháº¡y code (PHP).

Microservice cÅ©ng tháº¿: tÃ¡ch API Gateway (Nginx / Envoy) vÃ  cÃ¡c backend service (NestJS, Java, Goâ€¦).

CÃ¡ch nÃ y giÃºp:
Dá»… scale theo nhu cáº§u tá»«ng service.
Äá»™c láº­p version/ngÃ´n ngá»¯.
Dá»… deploy vÃ  update.

=============== vi du ======
Äá»ƒ mÃ¬nh lÃ m vÃ­ dá»¥ cá»¥ thá»ƒ nhÃ© â€“ nÃ³ ráº¥t giá»‘ng cÃ¡ch báº¡n vá»«a cháº¡y PHP-FPM vÃ  Nginx nhÆ°ng Ã¡p dá»¥ng cho microservice:

ğŸ§© TÃ¬nh huá»‘ng

Báº¡n cÃ³ user-service viáº¿t báº±ng NestJS.
Hiá»‡n táº¡i báº¡n Ä‘ang cháº¡y 3 container user-service version 1.0:

user-service-v1-1
user-service-v1-2
user-service-v1-3


Nginx (hoáº·c API Gateway) Ä‘ang reverse proxy theo kiá»ƒu round-robin Ä‘áº¿n 3 container nÃ y.

ğŸš€ Muá»‘n nÃ¢ng cáº¥p lÃªn version 1.1

Báº¡n build image má»›i:

docker build -t user-service:1.1 .


Rá»“i cháº¡y thÃªm 1 container má»›i vá»›i image má»›i:

user-service-v1.1-1


Cáº¥u hÃ¬nh Nginx sá»­a nháº¹ Ä‘á»ƒ route má»™t pháº§n traffic Ä‘áº¿n container má»›i (hoáº·c dÃ¹ng canary release: 5% traffic sang v1.1 Ä‘á»ƒ test).

VÃ­ dá»¥ upstream trong Nginx:

upstream user_service {
    server user-service-v1-1:3000;
    server user-service-v1-2:3000;
    server user-service-v1-3:3000;
    server user-service-v1.1-1:3000;  # thÃªm báº£n má»›i vÃ o
}


Báº¡n test tháº¥y version 1.1 á»•n â†’ spin thÃªm 2 container v1.1:

user-service-v1.1-2
user-service-v1.1-3


Rá»“i gá»¡ 3 container cÅ© v1.0 ra khá»i upstream.
=> NgÆ°á»i dÃ¹ng háº§u nhÆ° khÃ´ng bá»‹ downtime (Nginx luÃ´n cÃ³ container healthy Ä‘á»ƒ tráº£ lá»i).

âœ… Äá»™c láº­p version/ngÃ´n ngá»¯ lÃ :

Báº¡n cÃ³ thá»ƒ deploy version má»›i song song version cÅ©, khÃ´ng cáº§n táº¯t service cÅ© ngay.

CÃ³ thá»ƒ cháº¡y service má»›i báº±ng ngÃ´n ngá»¯ khÃ¡c mÃ  váº«n Ä‘á»ƒ Nginx route (vÃ­ dá»¥ user-service 1.0 viáº¿t NestJS, 1.1 viáº¿t GoLang cÅ©ng Ä‘Æ°á»£c).

Gateway/Nginx khÃ´ng quan tÃ¢m service viáº¿t báº±ng gÃ¬, miá»…n lÃ  tráº£ HTTP Ä‘Ãºng port lÃ  route Ä‘Æ°á»£c.


============== canary release=============
             +--------------------+
User Request â†’|  Nginx / API Gateway|
             +--------------------+
                 /      |      \
                /       |       \
               /        |        \
   +----------------+  +----------------+  +----------------+
   |user-service v1 |  |user-service v1 |  |user-service v1.1|
   |container 1     |  |container 2     |  |container (canary)|
   +----------------+  +----------------+  +----------------+
         ^                   ^                     ^
         |                   |                     |
         +-------90% traffic--+-----90% traffic-----+
                                                   |
                                                   +--10% traffic (test version má»›i)
90% traffic váº«n Ä‘i version 1.0 (container cÅ©).

10% traffic Ä‘i version 1.1 (container má»›i) Ä‘á»ƒ test.

Khi tháº¥y á»•n â†’ tÄƒng dáº§n % traffic cho v1.1 â†’ gá»¡ v1.0.

CÃ³ thá»ƒ lÃ m tá»‰ lá»‡ nÃ y ngay trong Nginx vá»›i weight:

upstream user_service {
    server user-service-v1-1:3000 weight=3;  # v1.0 nhiá»u weight hÆ¡n
    server user-service-v1-2:3000 weight=3;
    server user-service-v1.1-1:3000 weight=1;  # v1.1 Ã­t traffic hÆ¡n
}


Nhá» váº­y báº¡n:

KhÃ´ng giÃ¡n Ä‘oáº¡n dá»‹ch vá»¥ (zero downtime).

Test version má»›i ngay trong mÃ´i trÆ°á»ng tháº­t.

Dá»… rollback (chá»‰ cáº§n gá»¡ v1.1 khá»i upstream).


========= van de ======
van de 1: chung ta tat version cu nhu nao (gia su container cÅ© Ä‘ang xá»­ lÃ½ requett),
tat di co phai request do chua duoc thuc thi?
 Van de 2: viec cÃ³ hai version nhu vay, co phai lá»— há»•ng khÃ´ng, version 1 thuc hien
  logic A, version 2 thuc hien logic A nhung hoi khÃ¡c má»™t chÃºt, nhu váº­y request mÃ  gá»­i
   tá»›i version 2 se khÃ¡c vá»›i version 1. hmmm khÃ³ cÃ³ thá»ƒ cháº¥p nháº­n Ä‘Æ°á»£c

=> giai phap
van de 1:
Táº¯t version cÅ© khi nÃ³ Ä‘ang xá»­ lÃ½ request
Náº¿u báº¡n kill container Ä‘á»™t ngá»™t â†’ cÃ¡c request Ä‘ang cháº¡y trong container Ä‘Ã³ sáº½ fail (ngÆ°á»i dÃ¹ng nháº­n lá»—i).
â€œDrainâ€ traffic trÆ°á»›c khi táº¯t:
â€“ BÆ°á»›c 1: bá» container Ä‘Ã³ khá»i upstream (ngá»«ng nháº­n request má»›i).
â€“ BÆ°á»›c 2: Ä‘á»£i vÃ i giÃ¢y (hoáº·c cáº¥u hÃ¬nh â€œgraceful shutdownâ€) cho cÃ¡c request Ä‘ang cháº¡y xong.
â€“ BÆ°á»›c 3: sau khi container khÃ´ng cÃ²n request má»›i â†’ dá»«ng container.

VÃ­ dá»¥ trong Kubernetes cÃ³ terminationGracePeriodSeconds.
Trong Nginx cÃ³ thá»ƒ reload upstream Ä‘á»ƒ bá» server Ä‘Ã³ ra.
 Docker thuáº§n báº¡n cÅ©ng cÃ³ thá»ƒ chá»‰nh healthcheck Ä‘á»ƒ â€œfailâ€ â†’ load balancer khÃ´ng gá»­i request ná»¯a.


van de 2:
Hai version khÃ¡c logic â†’ request khÃ¡c nhau
ÄÃºng lÃ  náº¿u v1 vÃ  v2 xá»­ lÃ½ khÃ¡c nhau thÃ¬ cÃ³ thá»ƒ sinh ra dá»¯ liá»‡u â€œkhÃ´ng Ä‘á»“ng nháº¥tâ€. Äá»ƒ trÃ¡nh:
Backward compatibility: Version má»›i pháº£i tÆ°Æ¡ng thÃ­ch vá»›i version cÅ© (Ã­t nháº¥t vá»›i API vÃ  dá»¯ liá»‡u Ä‘ang dÃ¹ng).
Feature flag / toggle: ChÆ°a báº­t tÃ­nh nÄƒng má»›i trÃªn v2 cho Ä‘áº¿n khi cháº¯c cháº¯n, chá»‰ test â€œáº©nâ€ logic bÃªn trong.
TÃ¡ch traffic: Canary chá»‰ test vá»›i user ná»™i bá»™ hoáº·c má»™t nhÃ³m user cÃ³ thá»ƒ cháº¥p nháº­n thay Ä‘á»•i.
Dá»¯ liá»‡u chung: Náº¿u v1 vÃ  v2 cÃ¹ng ghi vÃ o DB thÃ¬ schema DB pháº£i backward-compatible, hoáº·c báº¡n dÃ¹ng DB riÃªng cho v2 Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t.
Náº¿u khÃ´ng lÃ m máº¥y nguyÃªn táº¯c Ä‘Ã³ thÃ¬ canary sáº½ thÃ nh â€œnguy hiá»ƒmâ€ tháº­t ğŸ˜…

